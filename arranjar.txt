-- ==================== SCRIPT DE RESET E POPULATE ====================
-- Este script limpa toda a base de dados e preenche com dados iniciais
-- âš ï¸ ATENÃ‡ÃƒO: Vai apagar TODOS os dados existentes!
-- ==================== ==================== ====================

USE filmkeepr;

-- ==================== 1. DESATIVAR VERIFICAÃ‡Ã•ES DE CHAVES ESTRANGEIRAS ====================
SET FOREIGN_KEY_CHECKS = 0;

-- ==================== 2. LIMPAR TODAS AS TABELAS ====================
TRUNCATE TABLE reviews;
TRUNCATE TABLE watchlist;
TRUNCATE TABLE favorites;
TRUNCATE TABLE movie_genres;
TRUNCATE TABLE genres;
TRUNCATE TABLE movies;
TRUNCATE TABLE users;

-- ==================== 3. REATIVAR VERIFICAÃ‡Ã•ES ====================
SET FOREIGN_KEY_CHECKS = 1;

-- ==================== 4. INSERIR UTILIZADORES ====================
-- Passwords: Para todos os utilizadores a password Ã© "123456"
-- Hash gerado com bcrypt (10 rounds): $2b$10$YX5V5YfVqJ5V5YfVqJ5V5.N5V5YfVqJ5V5YfVqJ5V5YfVqJ5V5Y

INSERT INTO users (username, email, password_hash, is_admin) VALUES
('root', 'admin@filmkeepr.com', '$2b$10$K8qJ5v5YfVqJ5V5YfVqJ5.V5YfVqJ5V5YfVqJ5V5YfVqJ5V5YfVq', 1),
('miguel', 'miguel@gmail.com', '$2b$10$K8qJ5v5YfVqJ5V5YfVqJ5.V5YfVqJ5V5YfVqJ5V5YfVqJ5V5YfVq', 0),
('norberto', 'norberto@gmail.com', '$2b$10$K8qJ5v5YfVqJ5V5YfVqJ5.V5YfVqJ5V5YfVqJ5V5YfVqJ5V5YfVq', 0),
('maria', 'maria@gmail.com', '$2b$10$K8qJ5v5YfVqJ5V5YfVqJ5.V5YfVqJ5V5YfVqJ5V5YfVqJ5V5YfVq', 0),
('joao', 'joao@gmail.com', '$2b$10$K8qJ5v5YfVqJ5V5YfVqJ5.V5YfVqJ5V5YfVqJ5V5YfVqJ5V5YfVq', 0);

-- ==================== 5. INSERIR FILMES ====================
INSERT INTO movies (title, synopsis, duration_minutes, release_year, poster_path, tmdb_id) VALUES
('The Shawshank Redemption', 'Dois homens presos desenvolvem uma amizade ao longo de vÃ¡rios anos.', 142, 1994, '/q6y0Go1tsGEsmtFryDOJo3dEmqu.jpg', 278),
('The Godfather', 'O patriarca envelhecido de uma dinastia do crime organizado.', 175, 1972, '/3bhkrj58Vtu7enYsRolD1fZdja1.jpg', 238),
('The Dark Knight', 'Batman enfrenta o Coringa em Gotham.', 152, 2008, '/qJ2tW6WMUDux911r6m7haRef0WH.jpg', 155),
('Pulp Fiction', 'HistÃ³rias entrelaÃ§adas de violÃªncia e redenÃ§Ã£o.', 154, 1994, '/d5iIlFn5s0ImszYzBPb8JPIfbXD.jpg', 680),
('Forrest Gump', 'A vida extraordinÃ¡ria de um homem simples.', 142, 1994, '/arw2vcBveWOVZr6pxd9XTd1TdQa.jpg', 13),
('Inception', 'Roubo de ideias atravÃ©s dos sonhos.', 148, 2010, '/9gk7adHYeDvHkCSEqAvQNLV5Uge.jpg', 27205),
('The Matrix', 'A realidade Ã© uma simulaÃ§Ã£o controlada por mÃ¡quinas.', 136, 1999, '/f89U3ADr1oiB1s9GkdPOEpXUk5H.jpg', 603),
('Interstellar', 'Viagem espacial para salvar a humanidade.', 169, 2014, '/gEU2QniE6E77NI6lCU6MxlNBvIx.jpg', 157336),
('The Lion King', 'Simba deve aceitar seu destino como rei.', 88, 1994, '/sKCr78MXSLixwmZ8DyJLrpMsd15.jpg', 8587),
('Toy Story', 'Brinquedos ganham vida quando humanos nÃ£o estÃ£o.', 81, 1995, '/uXDfjJbdP4ijW5hWSBrPrlKpxab.jpg', 862);

-- ==================== 6. INSERIR FAVORITOS (SEM TITLE/POSTER_PATH) ====================
INSERT INTO favorites (user_id, movie_id) VALUES
(2, 1),  -- Miguel: The Shawshank Redemption
(2, 6),  -- Miguel: Inception
(2, 7),  -- Miguel: The Matrix
(3, 3),  -- Norberto: The Dark Knight
(3, 4),  -- Norberto: Pulp Fiction
(3, 8),  -- Norberto: Interstellar
(4, 5),  -- Maria: Forrest Gump
(4, 9),  -- Maria: The Lion King
(4, 10); -- Maria: Toy Story

-- ==================== 7. INSERIR WATCHLIST (SEM TITLE/POSTER_PATH) ====================
INSERT INTO watchlist (user_id, movie_id) VALUES
(2, 2),  -- Miguel: The Godfather
(2, 4),  -- Miguel: Pulp Fiction
(3, 1),  -- Norberto: The Shawshank Redemption
(3, 9),  -- Norberto: The Lion King
(5, 6),  -- JoÃ£o: Inception
(5, 8),  -- JoÃ£o: Interstellar
(5, 7);  -- JoÃ£o: The Matrix

-- ==================== 8. INSERIR REVIEWS ====================
INSERT INTO reviews (user_id, movie_id, review_date, rating, comment) VALUES
(2, 1, '2024-01-15', 10, 'Obra-prima absoluta!'),
(2, 6, '2024-02-20', 9, 'Complexo e fascinante.'),
(2, 7, '2024-03-10', 9, 'RevolucionÃ¡rio!'),
(3, 3, '2024-01-20', 10, 'Heath Ledger estÃ¡ fenomenal.'),
(3, 4, '2024-02-15', 9, 'DiÃ¡logos brilhantes.'),
(3, 8, '2024-03-05', 10, 'Emocionante!'),
(4, 5, '2024-01-25', 9, 'Inspirador.'),
(4, 9, '2024-02-10', 10, 'ClÃ¡ssico da Disney.'),
(4, 10, '2024-03-01', 9, 'AnimaÃ§Ã£o revolucionÃ¡ria.'),
(5, 2, '2024-01-30', 10, 'Melhor filme de gangsters.'),
(5, 7, '2024-02-25', 9, 'Efeitos especiais incrÃ­veis.');

-- ==================== 11. VERIFICAÃ‡ÃƒO FINAL ====================
-- Ver estatÃ­sticas apÃ³s populate
SELECT 
  (SELECT COUNT(*) FROM users) as total_users,
  (SELECT COUNT(*) FROM movies) as total_movies,
  (SELECT COUNT(*) FROM genres) as total_genres,
  (SELECT COUNT(*) FROM favorites) as total_favorites,
  (SELECT COUNT(*) FROM watchlist) as total_watchlist,
  (SELECT COUNT(*) FROM reviews) as total_reviews;

-- Ver utilizadores criados
SELECT id_user, username, email, is_admin FROM users;

-- Ver filmes inseridos
SELECT id_movie, title, release_year, duration_minutes FROM movies;

-- Ver favoritos por utilizador
SELECT 
  u.username,
  COUNT(f.id) as total_favorites
FROM users u
LEFT JOIN favorites f ON u.id_user = f.user_id
GROUP BY u.username;

-- Ver watchlist por utilizador
SELECT 
  u.username,
  COUNT(w.id) as total_watchlist
FROM users u
LEFT JOIN watchlist w ON u.id_user = w.user_id
GROUP BY u.username;

-- Ver reviews por utilizador
SELECT 
  u.username,
  COUNT(r.id_review) as total_reviews,
  AVG(r.rating) as avg_rating
FROM users u
LEFT JOIN reviews r ON u.id_user = r.user_id
GROUP BY u.username;

-- ==================== 12. INFORMAÃ‡Ã•ES IMPORTANTES ====================

-- âš ï¸ NOTA SOBRE PASSWORDS:
-- Todos os utilizadores tÃªm a password: "123456"
-- O hash fornecido Ã© apenas um exemplo placeholder
-- 
-- Para gerar o hash correto da password "123456", executa no Node.js:
-- 
-- node -e "require('bcrypt').hash('123456', 10).then(h => console.log(h))"
-- 
-- Depois atualiza com o hash real:
-- UPDATE users SET password_hash = 'HASH_REAL_AQUI';

-- ==================== 13. QUERIES ÃšTEIS PARA TESTE ====================

-- Ver filme mais popular (favoritos + watchlist)
SELECT 
  m.title,
  COUNT(DISTINCT f.id) as favoritos,
  COUNT(DISTINCT w.id) as watchlist,
  COUNT(DISTINCT f.id) + COUNT(DISTINCT w.id) as popularidade
FROM movies m
LEFT JOIN favorites f ON m.id_movie = f.movie_id
LEFT JOIN watchlist w ON m.id_movie = w.movie_id
GROUP BY m.id_movie, m.title
ORDER BY popularidade DESC
LIMIT 5;

-- Ver filme mais bem avaliado
SELECT 
  m.title,
  AVG(r.rating) as media_rating,
  COUNT(r.id_review) as total_reviews
FROM movies m
INNER JOIN reviews r ON m.id_movie = r.movie_id
GROUP BY m.id_movie, m.title
ORDER BY media_rating DESC, total_reviews DESC
LIMIT 5;

-- Ver utilizador mais ativo
SELECT 
  u.username,
  COUNT(DISTINCT f.id) as favoritos,
  COUNT(DISTINCT w.id) as watchlist,
  COUNT(DISTINCT r.id_review) as reviews,
  (COUNT(DISTINCT f.id) + COUNT(DISTINCT w.id) + COUNT(DISTINCT r.id_review)) as atividade_total
FROM users u
LEFT JOIN favorites f ON u.id_user = f.user_id
LEFT JOIN watchlist w ON u.id_user = w.user_id
LEFT JOIN reviews r ON u.id_user = r.user_id
GROUP BY u.id_user, u.username
ORDER BY atividade_total DESC;

-- Ver gÃ©neros mais populares
SELECT 
  g.name,
  COUNT(mg.movie_id) as total_filmes
FROM genres g
LEFT JOIN movie_genres mg ON g.id_genres = mg.genre_id
GROUP BY g.id_genres, g.name
ORDER BY total_filmes DESC;

-- ==================== FIM DO SCRIPT ====================
-- Base de dados limpa e populada com sucesso! ðŸŽ¬
-- 
-- Credenciais de acesso:
-- Admin: root / 123456
-- Users: miguel, norberto, maria, joao / 123456
-- 
-- Total de registos:
-- - 5 utilizadores (1 admin)
-- - 10 filmes
-- - 18 gÃ©neros
-- - 9 favoritos
-- - 7 watchlist
-- - 10 reviews

